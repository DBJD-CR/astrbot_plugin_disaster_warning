<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®³é¢„è­¦ç®¡ç†ç«¯</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="app" class="app">
        <!-- MD3 Top App Bar -->
        <header class="top-app-bar">
            <h1>ç¾å®³é¢„è­¦ç®¡ç†ç«¯</h1>
            <div class="status-indicator">
                <span class="status-dot online"></span>
                <span>å®æ—¶ç›‘æ§ä¸­</span>
                <button class="btn btn-text" @click="toggleTheme" title="åˆ‡æ¢ä¸»é¢˜">
                    ğŸŒ“
                </button>
                <button class="btn btn-text" @click="openSettings" title="è®¾ç½®">
                    âš™ï¸
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <div class="dashboard-grid">
                <!-- Left Column: Status, Stats, Actions, Recent Events -->
                <div class="left-col">
                    <!-- Status Cards -->
                    <section class="cards-grid">
                        <!-- Service Status Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">ğŸ”„</span>
                                <h3>æœåŠ¡çŠ¶æ€</h3>
                            </div>
                            <div class="card-body">
                                <div class="status-item">
                                    <span>è¿è¡ŒçŠ¶æ€</span>
                                    <span :class="['status-badge', status.running ? 'running' : 'stopped']">
                                        {{ status.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢' }}
                                    </span>
                                </div>
                                <div class="status-item">
                                    <span>è¿è¡Œæ—¶é•¿</span>
                                    <span>{{ status.uptime }}</span>
                                </div>
                                <div class="status-item">
                                    <span>æ´»è·ƒè¿æ¥</span>
                                    <span>{{ status.activeConnections }} / {{ status.totalConnections }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">ğŸ“Š</span>
                                <h3>äº‹ä»¶ç»Ÿè®¡</h3>
                            </div>
                            <div class="card-body">
                                <div class="stat-number">{{ stats.totalEvents }}</div>
                                <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
                                <div class="stat-breakdown">
                                    <div class="stat-item">
                                        <span class="stat-icon">ğŸŒ</span>
                                        <span>{{ stats.earthquakeCount }}</span> åœ°éœ‡
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">ğŸŒŠ</span>
                                        <span>{{ stats.tsunamiCount }}</span> æµ·å•¸
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">â˜ï¸</span>
                                        <span>{{ stats.weatherCount }}</span> æ°”è±¡
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">âš¡</span>
                                <h3>å¿«æ·æ“ä½œ</h3>
                            </div>
                            <div class="card-body" style="flex-direction: row; flex-wrap: wrap;">
                                <button class="btn btn-primary" @click="testPush('earthquake')">
                                    ğŸ§ª æµ‹è¯•åœ°éœ‡
                                </button>
                                <button class="btn btn-secondary" @click="refreshAll">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Data Sources -->
                    <section>
                        <h2 class="section-title">ğŸ“¡ æ•°æ®æºè¿æ¥çŠ¶æ€</h2>
                        <div class="connections-grid">
                            <div v-if="sortedConnections.length === 0" class="loading">æš‚æ— è¿æ¥</div>
                            <div v-for="[name, info] in sortedConnections" :key="name"
                                :class="['connection-item', info.connected ? 'connected' : 'disconnected']">
                                <span class="conn-name">{{ name }}</span>
                                <div class="conn-status">
                                    <span>{{ info.connected ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿' }}</span>
                                    <span v-if="info.retry_count > 0">(é‡è¯•: {{ info.retry_count }})</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Magnitude Distribution -->
                    <section>
                        <h2 class="section-title">ğŸ“ˆ éœ‡çº§åˆ†å¸ƒ</h2>
                        <div class="card">
                            <div class="chart-container">
                                <div v-if="Object.keys(magnitudeDistribution).length === 0" class="loading">åŠ è½½ä¸­...</div>
                                <div v-else class="mag-bars">
                                    <div v-for="label in magnitudeOrder" :key="label" class="mag-bar-wrapper">
                                        <div class="mag-value">{{ magnitudeDistribution[label] || 0 }}</div>
                                        <div class="mag-bar"
                                            :style="{ height: ((magnitudeDistribution[label] || 0) === 0 ? 2 : ((magnitudeDistribution[label] || 0) / maxMagnitudeValue) * 70) + '%' }">
                                        </div>
                                        <div class="mag-label" v-html="label.replace(' - ', '-<br>')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Right Column -->
                    <div class="right-col">
                    </div>
                </div>

                <!-- Recent Events (Full Width) -->
                <section>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 class="section-title" style="margin-bottom: 0;">ğŸ“‹ æœ€è¿‘äº‹ä»¶</h2>
                        <!-- Optional: Filter or View All button could go here -->
                    </div>

                    <div class="events-list events-grid-layout">
                        <!-- Changed to Grid for better full-width utilization -->
                        <div v-if="sortedRecentEvents.length === 0" class="loading">æš‚æ— äº‹ä»¶è®°å½•</div>
                        <template v-for="evt in sortedRecentEvents" :key="evt.time + evt.description">
                            <!-- Earthquake Event -->
                            <div v-if="evt.type === 'earthquake' || evt.type === 'earthquake_warning'"
                                class="event-card">
                                <div :class="['mag-badge', getMagColorClass(evt.magnitude || 0)]">
                                    M{{ (evt.magnitude || 0).toFixed(1) }}
                                </div>
                                <div class="event-main">
                                    <div class="event-loc">{{ evt.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                    <div class="event-meta">
                                        <span class="time-tag">{{ formatTimeFriendly(evt.time) }}</span>
                                        <span class="source-tag">{{ evt.source || 'æœªçŸ¥æ¥æº' }}</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Other Events -->
                            <div v-else class="event-card">
                                <div class="mag-badge" style="background-color: var(--md-sys-color-secondary);">
                                    {{ evt.type === 'tsunami' ? 'ğŸŒŠ' : (evt.type === 'weather_alarm' ? 'â˜ï¸' : 'â“')
                                    }}
                                </div>
                                <div class="event-main">
                                    <div class="event-loc">{{ evt.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                    <div class="event-meta">
                                        <span class="time-tag">{{ formatTimeFriendly(evt.time) }}</span>
                                        <span class="source-tag">{{ evt.source || 'æœªçŸ¥æ¥æº' }}</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>ç¾å®³é¢„è­¦æ’ä»¶ Web ç®¡ç†ç«¯ | æœ€åæ›´æ–°: <span>{{ lastUpdate }}</span></p>
        </footer>

        <!-- Settings Modal (MD3 Dialog) -->
        <div v-show="showSettings" class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âš™ï¸ æ’ä»¶é…ç½®</h2>
                    <span class="close-modal" @click="closeSettings">&times;</span>
                </div>
                <div class="modal-body" id="settings-form">
                    <div v-if="!schema || !fullConfig" class="loading">åŠ è½½é…ç½®ä¸­...</div>
                    <config-renderer v-else :schema="schema" :config="fullConfig"></config-renderer>
                </div>
                <div class="modal-footer"
                    style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-text" @click="closeSettings">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveSettings" :disabled="settingsSaving">
                        {{ settingsSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…ç½®' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Config Renderer Component -->
    <script src="js/config_renderer.js"></script>
    <!-- Vue App -->
    <script src="js/app.vue.js"></script>
</body>

</html>