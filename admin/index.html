<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®³é¢„è­¦ç®¡ç†ç«¯</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="app" class="app">
        <!-- MD3 Top App Bar -->
        <header class="top-app-bar">
            <h1>ç¾å®³é¢„è­¦ç®¡ç†ç«¯</h1>
            <div class="status-indicator">
                <span :class="['status-dot', wsConnected ? 'online' : 'offline']"></span>
                <span>{{ wsConnected ? 'å®æ—¶ç›‘æ§ä¸­' : 'è¿æ¥æ–­å¼€' }}</span>
                <button class="btn btn-text" @click="toggleTheme" title="åˆ‡æ¢ä¸»é¢˜">
                    ğŸŒ“
                </button>
                <button class="btn btn-text" @click="openSettings" title="è®¾ç½®">
                    âš™ï¸
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <div class="dashboard-grid">
                <!-- Left Column: Status, Stats, Actions, Recent Events -->
                <div class="left-col">
                    <!-- Status Cards -->
                    <section class="cards-grid">
                        <!-- Service Status Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">ğŸ”„</span>
                                <h3>æœåŠ¡çŠ¶æ€</h3>
                            </div>
                            <div class="card-body">
                                <div class="status-item">
                                    <span>è¿è¡ŒçŠ¶æ€</span>
                                    <span :class="['status-badge', status.running ? 'running' : 'stopped']">
                                        {{ status.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢' }}
                                    </span>
                                </div>
                                <div class="status-item">
                                    <span>è¿è¡Œæ—¶é•¿</span>
                                    <span>{{ status.uptime }}</span>
                                </div>
                                <div class="status-item">
                                    <span>æ´»è·ƒè¿æ¥</span>
                                    <span>{{ status.activeConnections }} / {{ status.totalConnections }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">ğŸ“Š</span>
                                <h3>äº‹ä»¶ç»Ÿè®¡</h3>
                            </div>
                            <div class="card-body">
                                <div class="stat-number">{{ stats.totalEvents }}</div>
                                <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
                                <div class="stat-breakdown">
                                    <div class="stat-item">
                                        <span class="stat-icon">ğŸŒ</span>
                                        <span>{{ stats.earthquakeCount }}</span> åœ°éœ‡
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">ğŸŒŠ</span>
                                        <span>{{ stats.tsunamiCount }}</span> æµ·å•¸
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">â˜ï¸</span>
                                        <span>{{ stats.weatherCount }}</span> æ°”è±¡
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-icon">âš¡</span>
                                <h3>å¿«æ·æ“ä½œ</h3>
                            </div>
                            <div class="card-body" style="flex-direction: row; flex-wrap: wrap;">
                                <button class="btn btn-primary" @click="openSimulation">
                                    ğŸ§ª æ¨¡æ‹Ÿé¢„è­¦
                                </button>
                                <button class="btn btn-secondary" @click="refreshAll">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Data Sources -->
                    <section>
                        <h2 class="section-title">ğŸ“¡ æ•°æ®æºè¿æ¥çŠ¶æ€</h2>
                        <div class="connections-grid">
                            <div v-if="sortedConnections.length === 0" class="loading">æš‚æ— è¿æ¥</div>
                            <div v-for="[name, info] in sortedConnections" :key="name"
                                :class="['connection-item', info.connected ? 'connected' : 'disconnected']">
                                <span class="conn-name">{{ name }}</span>
                                <div class="conn-status">
                                    <span>{{ info.connected ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿' }}</span>
                                    <span v-if="info.retry_count > 0">(é‡è¯•: {{ info.retry_count }})</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Magnitude Distribution -->
                    <section>
                        <h2 class="section-title">ğŸ“ˆ éœ‡çº§åˆ†å¸ƒ</h2>
                        <div class="card">
                            <div class="chart-container">
                                <div v-if="Object.keys(magnitudeDistribution).length === 0" class="loading">åŠ è½½ä¸­...</div>
                                <div v-else class="mag-bars">
                                    <div v-for="label in magnitudeOrder" :key="label" class="mag-bar-wrapper">
                                        <div class="mag-value">{{ magnitudeDistribution[label] || 0 }}</div>
                                        <div class="mag-bar"
                                            :style="{ height: ((magnitudeDistribution[label] || 0) === 0 ? 2 : ((magnitudeDistribution[label] || 0) / maxMagnitudeValue) * 70) + '%' }">
                                        </div>
                                        <div class="mag-label" v-html="label.replace(' - ', '-<br>')"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Right Column -->
                    <div class="right-col">
                    </div>
                </div>

                <!-- Recent Events (Full Width) -->
                <section>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;">ğŸ“‹ æœ€è¿‘äº‹ä»¶</h2>
                        <div class="filter-group">
                            <button class="btn btn-sm btn-filter" :class="{ active: filterType === 'all' }"
                                @click="setFilter('all')">å…¨éƒ¨</button>
                            <button class="btn btn-sm btn-filter" :class="{ active: filterType === 'earthquake' }"
                                @click="setFilter('earthquake')">åœ°éœ‡</button>
                            <button class="btn btn-sm btn-filter" :class="{ active: filterType === 'tsunami' }"
                                @click="setFilter('tsunami')">æµ·å•¸</button>
                            <button class="btn btn-sm btn-filter" :class="{ active: filterType === 'weather' }"
                                @click="setFilter('weather')">æ°”è±¡</button>
                        </div>
                    </div>

                    <div class="events-list events-grid-layout">
                        <!-- Changed to Grid for better full-width utilization -->
                        <div v-if="groupedEvents.length === 0" class="loading" style="grid-column: 1 / -1;">æš‚æ— äº‹ä»¶è®°å½•</div>
                        <template v-for="group in groupedEvents" :key="group.id">
                            <!-- Event Group Container -->
                            <div class="event-group"
                                :class="{ 'expanded': isEventGroupExpanded(group.id), 'has-updates': group.updateCount > 1 }">
                                <!-- Main Event Card (Latest) -->
                                <div class="event-card event-card-main"
                                    @click="group.updateCount > 1 && toggleEventGroup(group.id, $event)"
                                    :class="{ 'clickable': group.updateCount > 1 }">
                                    <!-- Earthquake Event -->
                                    <template
                                        v-if="group.latestEvent.type === 'earthquake' || group.latestEvent.type === 'earthquake_warning'">
                                        <div :class="['mag-badge', getMagColorClass(group.latestEvent.magnitude || 0)]">
                                            M{{ (group.latestEvent.magnitude || 0).toFixed(1) }}
                                        </div>
                                        <div class="event-main">
                                            <div class="event-loc">{{ group.latestEvent.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                            <div class="event-meta">
                                                <span class="time-tag">{{ formatTimeFriendly(group.latestEvent.time)
                                                    }}</span>
                                                <span class="source-tag">{{ group.latestEvent.source || 'æœªçŸ¥æ¥æº' }}</span>
                                            </div>
                                        </div>
                                    </template>
                                    <!-- Tsunami Event -->
                                    <template v-else-if="group.latestEvent.type === 'tsunami'">
                                        <div class="mag-badge tsunami-badge-style">
                                            ğŸŒŠ
                                        </div>
                                        <div class="event-main">
                                            <div class="event-loc">{{ group.latestEvent.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                            <div class="event-meta">
                                                <span class="time-tag">{{ formatTimeFriendly(group.latestEvent.time)
                                                    }}</span>
                                                <span class="source-tag">{{ group.latestEvent.source || 'æœªçŸ¥æ¥æº' }}</span>
                                            </div>
                                        </div>
                                    </template>
                                    <!-- Weather Event -->
                                    <template v-else-if="group.latestEvent.type === 'weather_alarm'">
                                        <div
                                            :class="['mag-badge', getWeatherColorClass(group.latestEvent.description)]">
                                            â˜ï¸
                                        </div>
                                        <div class="event-main">
                                            <div class="event-loc">{{ group.latestEvent.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                            <div class="event-meta">
                                                <span class="time-tag">{{ formatTimeFriendly(group.latestEvent.time)
                                                    }}</span>
                                                <span class="source-tag">{{ group.latestEvent.source || 'æœªçŸ¥æ¥æº' }}</span>
                                            </div>
                                        </div>
                                    </template>
                                    <!-- Other Events -->
                                    <template v-else>
                                        <div class="mag-badge" style="background-color: var(--md-sys-color-secondary);">
                                            â“
                                        </div>
                                        <div class="event-main">
                                            <div class="event-loc">{{ group.latestEvent.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                            <div class="event-meta">
                                                <span class="time-tag">{{ formatTimeFriendly(group.latestEvent.time)
                                                    }}</span>
                                                <span class="source-tag">{{ group.latestEvent.source || 'æœªçŸ¥æ¥æº' }}</span>
                                            </div>
                                        </div>
                                    </template>
                                    <!-- Update Count Badge -->
                                    <div v-if="group.updateCount > 1" class="update-badge">
                                        <span class="update-count">{{ group.updateCount }}</span>
                                        <span class="update-icon">{{ isEventGroupExpanded(group.id) ? 'â–²' : 'â–¼'
                                            }}</span>
                                    </div>
                                </div>
                                <!-- Expanded History Wrapper -->
                                <div class="event-history-wrapper"
                                    :class="{ 'is-open': isEventGroupExpanded(group.id) }" v-if="group.updateCount > 1"
                                    :style="{ '--origin-x': getEventOrigin(group.id) }">
                                    <div class="event-history-inner">
                                        <div v-for="(evt, idx) in group.events.slice(1)" :key="idx"
                                            class="event-card event-card-history">
                                            <template
                                                v-if="evt.type === 'earthquake' || evt.type === 'earthquake_warning'">
                                                <div
                                                    :class="['mag-badge mag-badge-sm', getMagColorClass(evt.magnitude || 0)]">
                                                    M{{ (evt.magnitude || 0).toFixed(1) }}
                                                </div>
                                                <div class="event-main">
                                                    <div class="event-loc">{{ evt.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                                    <div class="event-meta">
                                                        <span class="time-tag">{{ formatTimeFriendly(evt.time) }}</span>
                                                        <span class="source-tag">{{ evt.source || 'æœªçŸ¥æ¥æº' }}</span>
                                                    </div>
                                                </div>
                                            </template>
                                            <template v-else>
                                                <div class="mag-badge mag-badge-sm"
                                                    style="background-color: var(--md-sys-color-secondary);">
                                                    {{ evt.type === 'tsunami' ? 'ğŸŒŠ' : (evt.type === 'weather_alarm' ?
                                                    'â˜ï¸'
                                                    : 'â“') }}
                                                </div>
                                                <div class="event-main">
                                                    <div class="event-loc">{{ evt.description || 'æœªçŸ¥ä½ç½®' }}</div>
                                                    <div class="event-meta">
                                                        <span class="time-tag">{{ formatTimeFriendly(evt.time) }}</span>
                                                        <span class="source-tag">{{ evt.source || 'æœªçŸ¥æ¥æº' }}</span>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>ç¾å®³é¢„è­¦æ’ä»¶ Web ç®¡ç†ç«¯</p>
        </footer>

        <!-- Simulation Modal -->
        <div v-show="showSimulation" class="modal" style="display: block;">
            <div class="modal-content simulation-modal">
                <div class="modal-header">
                    <h2>ğŸ§ª æ¨¡æ‹Ÿé¢„è­¦æµ‹è¯•</h2>
                    <span class="close-modal" @click="closeSimulation">&times;</span>
                </div>
                <div class="modal-body">
                    <div v-if="!simulationOptions" class="loading">åŠ è½½ä¸­...</div>
                    <div v-else class="simulation-form">
                        <!-- ç›®æ ‡ç¾¤ -->
                        <div class="form-group">
                            <label>ç›®æ ‡ç¾¤ç»„</label>
                            <select v-model="simulationForm.targetGroup" class="form-control">
                                <option value="">é»˜è®¤ï¼ˆç¬¬ä¸€ä¸ªé…ç½®çš„ç¾¤ï¼‰</option>
                                <option v-for="group in simulationOptions.target_groups" :key="group" :value="group">
                                    {{ group }}
                                </option>
                            </select>
                        </div>

                        <!-- ç¾å®³ç±»å‹ -->
                        <div class="form-group">
                            <label>ç¾å®³ç±»å‹</label>
                            <div class="disaster-type-buttons">
                                <button v-for="(info, type) in simulationOptions.disaster_types" :key="type"
                                    :class="['btn', 'btn-type', simulationForm.disasterType === type ? 'btn-type-active' : '']"
                                    @click="selectDisasterType(type, info)">
                                    {{ info.icon }} {{ info.label }}
                                </button>
                            </div>
                        </div>

                        <!-- æµ‹è¯•æ ¼å¼ -->
                        <div class="form-group" v-if="currentDisasterFormats.length > 0">
                            <label>æµ‹è¯•æ ¼å¼</label>
                            <select v-model="simulationForm.testType" class="form-control">
                                <option v-for="fmt in currentDisasterFormats" :key="fmt.value" :value="fmt.value">
                                    {{ fmt.label }}
                                </option>
                            </select>
                        </div>

                        <!-- è‡ªå®šä¹‰å‚æ•°åŒºåŸŸ (ä»…åœ°éœ‡) -->
                        <div v-if="simulationForm.disasterType === 'earthquake'" class="custom-params-section">
                            <div class="section-divider">
                                <span>è‡ªå®šä¹‰å‚æ•°</span>
                            </div>

                            <div class="params-grid">
                                <!-- éœ‡çº§ -->
                                <div class="form-group">
                                    <label>éœ‡çº§ (M)</label>
                                    <input type="number" v-model="simulationForm.customParams.magnitude"
                                        class="form-control" step="0.1" min="0" max="10" placeholder="5.5">
                                </div>

                                <!-- æ·±åº¦ -->
                                <div class="form-group">
                                    <label>æ·±åº¦ (km)</label>
                                    <input type="number" v-model="simulationForm.customParams.depth"
                                        class="form-control" step="1" min="0" max="700" placeholder="10">
                                </div>

                                <!-- çº¬åº¦ -->
                                <div class="form-group">
                                    <label>çº¬åº¦</label>
                                    <input type="number" v-model="simulationForm.customParams.latitude"
                                        class="form-control" step="0.01" min="-90" max="90" placeholder="31.2">
                                </div>

                                <!-- ç»åº¦ -->
                                <div class="form-group">
                                    <label>ç»åº¦</label>
                                    <input type="number" v-model="simulationForm.customParams.longitude"
                                        class="form-control" step="0.01" min="-180" max="180" placeholder="103.8">
                                </div>
                            </div>

                            <!-- Auto-locate button (single row after coordinates) -->
                            <div class="form-group" style="text-align: center;">
                                <button @click="autoLocateSimulation" :disabled="simulationGeolocating"
                                    class="btn btn-secondary" type="button" style="width: 100%; padding: 10px;">
                                    {{ simulationGeolocating ? 'å®šä½ä¸­...' : 'ğŸŒ ä½¿ç”¨å½“å‰ä½ç½®' }}
                                </button>
                            </div>

                            <!-- åœ°å (å•ç‹¬ä¸€è¡Œ) -->
                            <div class="form-group">
                                <label>éœ‡ä¸­åœ°å</label>
                                <input type="text" v-model="simulationForm.customParams.place_name" class="form-control"
                                    placeholder="å¦‚ï¼šå››å·çœæˆéƒ½å¸‚">
                            </div>
                        </div>

                        <!-- æç¤ºä¿¡æ¯ -->
                        <div class="simulation-tip">
                            <span class="tip-icon">â„¹ï¸</span>
                            <span>ç•™ç©ºçš„å‚æ•°å°†ä½¿ç”¨é»˜è®¤æµ‹è¯•å€¼ã€‚è¿™å°†å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯åˆ°é€‰å®šçš„ç¾¤ç»„ï¼Œè¯·ç¡®ä¿æœºå™¨äººå·²è¿æ¥ã€‚</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"
                    style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-text" @click="closeSimulation">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="sendSimulation"
                        :disabled="simulationSending || !simulationOptions">
                        {{ simulationSending ? 'å‘é€ä¸­...' : 'ğŸ“¤ å‘é€æµ‹è¯•' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal (MD3 Dialog) -->
        <div v-show="showSettings" class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âš™ï¸ æ’ä»¶é…ç½®</h2>
                    <span class="close-modal" @click="closeSettings">&times;</span>
                </div>
                <div class="modal-body" id="settings-form">
                    <div v-if="!schema || !fullConfig" class="loading">åŠ è½½é…ç½®ä¸­...</div>
                    <config-renderer v-else :schema="schema" :config="fullConfig"></config-renderer>
                </div>
                <div class="modal-footer"
                    style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-text" @click="closeSettings">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="saveSettings" :disabled="settingsSaving">
                        {{ settingsSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…ç½®' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Config Renderer Component -->
    <script src="js/config_renderer.js"></script>
    <!-- Vue App -->
    <script src="js/app.vue.js"></script>
</body>

</html>