name: ğŸ’© å±å±±ä»£ç æ£€æµ‹

on:
  push:
    branches: [ main, master, dev/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  shit-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ fuck-u-code
        run: |
          curl -L -o fuck-u-code \
            https://github.com/Done-0/fuck-u-code/releases/latest/download/fuck-u-code-linux-amd64
          chmod +x fuck-u-code

      - name: è¿è¡Œå±å±±åˆ†æ & è¯¦ç»†è¯„åˆ†
        id: analyze
        run: |
          ./fuck-u-code analyze --verbose --lang zh-CN --top 10 2>&1 | tee analysis.log
          
          # æå–åˆ†æ•°ï¼ˆæ”¯æŒå°æ•°ï¼Œå¦‚ 43.76ï¼‰
          SCORE=$(grep -oP "æ€»ä½“è¯„åˆ†:\s*\K[0-9.]+" analysis.log | head -1)
          if [ -z "$SCORE" ]; then SCORE="0"; fi
          
          echo "åŸå§‹åˆ†æ•°: $SCORE"
          
          # è¯¦ç»†ç­‰çº§åˆ¤æ–­ï¼ˆåŸºäºå®˜æ–¹ 6 çº§æ ‡å‡†ï¼‰
          # 0-39: ğŸŒ± æ¸…æ´ï¼ˆç»¿è‰²ï¼‰
          # 40-54: ğŸ’© å±å±±çº§åˆ«/å±æ°”æ‰‘é¼»ï¼ˆæ©™è‰²ï¼‰  
          # 55-74: ğŸ¤• ç¾éš¾ï¼ˆçº¢è‰²ï¼‰
          # 75-84: ğŸ§Ÿ éå¸¸ç³Ÿç³•ï¼ˆæ·±çº¢ï¼‰
          # 85-100: â˜¢ï¸ æç«¯ç¾éš¾ï¼ˆç´«è‰²ï¼‰
          
          STATUS=""
          COLOR=""
          EMOJI=""
          DESC=""
          ALLOW_MERGE="true"
          
          # bc æ¯”è¾ƒæµ®ç‚¹æ•°
          if (( $(echo "$SCORE < 40" | bc -l) )); then
            EMOJI="ğŸŒ±"
            STATUS="ä¼˜ç§€"
            COLOR="brightgreen"
            DESC="ä»£ç æ¸…æ–°ï¼Œç»§ç»­ä¿æŒ"
            ALLOW_MERGE="true"
            echo "âœ… æ£€æµ‹ç»“æœï¼šæ¸…æ´çº§ - ä½ æ˜¯ä»£ç æ´ç™–çš„éª„å‚²ï¼"
            
          elif (( $(echo "$SCORE >= 40 && $SCORE < 55" | bc -l) )); then
            EMOJI="ğŸ’©"
            STATUS="å±æ°”æ‰‘é¼»"
            COLOR="orange"
            DESC="ä»£ç å¼€å§‹æ•£å‘æ°”å‘³ï¼Œè°¨æ…ç»´æŠ¤"
            ALLOW_MERGE="true"
            echo "âš ï¸  æ£€æµ‹ç»“æœï¼šå±å±±çº§(è½»åº¦) - æœ‰ç‚¹å‘³é“ä½†èƒ½è·‘"
            
          elif (( $(echo "$SCORE >= 55 && $SCORE < 75" | bc -l) )); then
            EMOJI="ğŸ¤•"
            STATUS="ç¾éš¾"
            COLOR="red"
            DESC="éœ€è¦å¤§å¹…é‡æ„ï¼Œç»´æŠ¤å›°éš¾"
            ALLOW_MERGE="false"  # å»ºè®®ç¦æ­¢åˆå¹¶
            echo "::warning::âŒ æ£€æµ‹ç»“æœï¼šç¾éš¾çº§ - å»ºè®®ç«‹åˆ»é‡æ„ï¼"
            
          elif (( $(echo "$SCORE >= 75 && $SCORE < 85" | bc -l) )); then
            EMOJI="ğŸ§Ÿ"
            STATUS="éå¸¸ç³Ÿç³•"
            COLOR="#8B0000"  # æ·±çº¢è‰²
            DESC="æ¥è¿‘ä¸å¯æ•‘è¯ï¼Œé£é™©æé«˜"
            ALLOW_MERGE="false"
            echo "::error::ğŸ’€ æ£€æµ‹ç»“æœï¼šå±é™©çº§ - è¿™ä»£ç æœ‰æ¯’ï¼"
            
          else  # 85-100
            EMOJI="â˜¢ï¸"
            STATUS="æç«¯ç¾éš¾"
            COLOR="purple"  # æˆ–è€… #800080
            DESC="å®Œå…¨å¤±æ§ï¼Œå»ºè®®é‡å†™"
            ALLOW_MERGE="false"
            echo "::error::â˜¢ï¸ æ£€æµ‹ç»“æœï¼šç»ˆæç¾éš¾ - åŠä½ åˆ åº“è·‘è·¯ï¼"
          fi
          
          # è¾“å‡ºåˆ° GitHub Actions ç¯å¢ƒ
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "allow_merge=$ALLOW_MERGE" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ‘˜è¦
          echo "### $EMOJI å±å±±æ£€æµ‹æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| **æ€»ä½“è¯„åˆ†** | $SCORE / 100 |" >> $GITHUB_STEP_SUMMARY
          echo "| **å±å±±ç­‰çº§** | $STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| **è¯„ä¼°æè¿°** | $DESC |" >> $GITHUB_STEP_SUMMARY
          echo "| **åˆå¹¶å»ºè®®** | $([ "$ALLOW_MERGE" == "true" ] && echo "âœ… å…è®¸" || echo "âŒ ç¦æ­¢") |" >> $GITHUB_STEP_SUMMARY
      
      # åœ¨ PR è¯„è®ºé‡Œæ˜¾ç¤ºè¯¦ç»†ç­‰çº§
      - name: PR è¯„è®ºï¼ˆè¯¦ç»†ç‰ˆï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.analyze.outputs.score }}';
            const status = '${{ steps.analyze.outputs.status }}';
            const emoji = '${{ steps.analyze.outputs.emoji }}';
            const desc = '${{ steps.analyze.outputs.desc }}';
            const allowMerge = '${{ steps.analyze.outputs.allow_merge }}';
            
            let advice = '';
            if (parseFloat(score) < 40) {
              advice = 'ğŸ‘ **ä¿æŒç°çŠ¶ï¼** ä½ çš„ä»£ç è´¨é‡è¶…è¿‡ 90% çš„å¼€æºé¡¹ç›®ã€‚';
            } else if (parseFloat(score) < 55) {
              advice = 'ğŸ’¡ **å»ºè®®ï¼š** é‡ç‚¹å…³æ³¨å¾ªç¯å¤æ‚åº¦å’Œå‡½æ•°é•¿åº¦ï¼Œå°è¯•æ‹†åˆ†æ ¸å¿ƒé€»è¾‘ã€‚';
            } else if (parseFloat(score) < 75) {
              advice = 'ğŸš¨ **è­¦å‘Šï¼š** å»ºè®®ä¼˜å…ˆé‡æ„ Top 3 é—®é¢˜æ–‡ä»¶ï¼Œé¿å…æŠ€æœ¯å€ºåŠ¡ç´¯ç§¯ã€‚';
            } else {
              advice = 'ğŸ’€ **å±é™©ï¼š** å»ºè®®æš‚åœåŠŸèƒ½å¼€å‘ï¼Œå…ˆè¿›è¡Œä»£ç è¿˜å€ºï¼Œæˆ–è€ƒè™‘é‡å†™æ–¹æ¡ˆã€‚';
            }
            
            const mergeBadge = allowMerge === 'true' 
              ? '![å…è®¸åˆå¹¶](https://img.shields.io/badge/åˆå¹¶-å…è®¸-brightgreen)'
              : '![ç¦æ­¢åˆå¹¶](https://img.shields.io/badge/åˆå¹¶-ç¦æ­¢-red)';
            
            const body = '## ' + emoji + ' å±å±±ä»£ç æ£€æµ‹æŠ¥å‘Š ' + mergeBadge + '\n\n' +
              '| æŒ‡æ ‡ | è¯¦æƒ… |\n' +
              '|:------|:------|\n' +
              '| **æ€»ä½“è¯„åˆ†** | `' + score + ' / 100` |\n' +
              '| **å±å±±ç­‰çº§** | **' + status + '** |\n' +
              '| **ç­‰çº§æè¿°** | ' + desc + ' |\n' +
              '| **æ£€æµ‹æ—¶é—´** | ' + new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) + ' |\n' +
              '### ğŸ’¡ è¯„ä¼°å»ºè®®\n' +
              advice + '\n\n' +
              '### ğŸ“Š è¯¦ç»†æ•°æ®\n' +
              '- [æŸ¥çœ‹å®Œæ•´åˆ†ææŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n' +
              '- [ä¸‹è½½ Markdown æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)\n\n' +
              '*ç”± [fuck-u-code](https://github.com/Done-0/fuck-u-code) è‡ªåŠ¨æ£€æµ‹*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      # æ ¹æ®ç­‰çº§å†³å®šæ˜¯å¦é˜»æ–­åˆå¹¶ï¼ˆå¯é€‰ï¼‰
      - name: é—¨ç¦æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
        if: steps.analyze.outputs.allow_merge != 'true'
        run: |
          echo "âŒ å±å±±æŒ‡æ•° ${{ steps.analyze.outputs.score }} å·²è¾¾åˆ°ã€Œ${{ steps.analyze.outputs.status }}ã€çº§åˆ«"
          echo "   ${{ steps.analyze.outputs.desc }}"
          echo "::error::ä»£ç è´¨é‡æœªè¾¾æ ‡ï¼Œå»ºè®®é‡æ„åå†åˆå¹¶"
          # éœ€è¦é˜»æ–­å°±å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼š
          # exit 1