name: 💩 屎山代码检测

on:
  push:
    branches: [ main, master, dev/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  shit-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # 用于 PR 评论
      issues: write         # 用于 Issue 评论（可选）
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      
      - name: 下载 fuck-u-code
        run: |
          echo "📥 正在下载最新版 fuck-u-code..."
          curl -L -o fuck-u-code \
            https://github.com/Done-0/fuck-u-code/releases/latest/download/fuck-u-code-linux-amd64
          chmod +x fuck-u-code
          echo "✅ 下载完成"
      
      - name: 运行屎山分析
        id: analyze
        run: |
          echo "🔍 开始分析代码..."
          ./fuck-u-code analyze --json --top 10 > report.json
          
          # 解析 JSON 获取关键数据
          SCORE=$(jq -r '.score' report.json)
          LEVEL=$(jq -r '.level' report.json)
          FILES=$(jq -r '.files_analyzed' report.json)
          ISSUES=$(jq -r '.total_issues' report.json)
          
          # 根据分数设置颜色（shields.io 格式）
          if (( $(echo "$SCORE > 55" | bc -l) )); then
            COLOR="red"
            STATUS="灾难级"
          elif (( $(echo "$SCORE > 45" | bc -l) )); then
            COLOR="orange"
            STATUS="屎气扑鼻"
          elif (( $(echo "$SCORE > 35" | bc -l) )); then
            COLOR="yellow"
            STATUS="需要关注"
          else
            COLOR="green"
            STATUS="清洁"
          fi
          
          # 输出到 GitHub Actions 环境，供后续步骤使用
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          
          echo "📊 分析结果："
          echo "   分数: $SCORE"
          echo "   等级: $LEVEL"
          echo "   文件: $FILES"
          echo "   问题: $ISSUES"
      
      - name: 生成 Markdown 报告
        run: |
          ./fuck-u-code analyze --markdown --lang zh-CN > shit-report.md
          echo "📄 Markdown 报告已生成"
      
      - name: 上传分析报告
        uses: actions/upload-artifact@v4
        with:
          name: shit-mountain-report-${{ github.sha }}
          path: |
            report.json
            shit-report.md
          retention-days: 30
      
      - name: PR 评论（如果是 Pull Request）
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.analyze.outputs.score }}';
            const level = '${{ steps.analyze.outputs.level }}';
            const files = '${{ steps.analyze.outputs.files }}';
            const issues = '${{ steps.analyze.outputs.issues }}';
            const status = '${{ steps.analyze.outputs.status }}';
            
            // 根据分数选 emoji
            let emoji = '🌱';
            if (parseFloat(score) > 55) emoji = '💀';
            else if (parseFloat(score) > 45) emoji = '💩';
            else if (parseFloat(score) > 35) emoji = '⚠️';
            
            const body = `${emoji} **屎山代码检测报告**
            
            | 指标 | 数值 |
            |------|------|
            | **屎山指数** | \`${score}\` |
            | **等级** | ${level} (${status}) |
            | **分析文件** | ${files} 个 |
            | **发现问题** | ${issues} 处 |
            
            <details>
            <summary>📋 查看详细报告</summary>
            
            下载 [Markdown 报告](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) 查看完整的 Top 10 屎山文件。
            
            </details>
            
            *由 [fuck-u-code](https://github.com/Done-0/fuck-u-code) 自动生成*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: 检查阈值（可选：超过阈值则失败）
        if: always()  # 总是运行，即使前面步骤失败
        run: |
          SCORE=${{ steps.analyze.outputs.score }}
          LIMIT=55  # 设置你的阈值
          
          if (( $(echo "$SCORE > $LIMIT" | bc -l) )); then
            echo "❌ 屎山指数 $SCORE 超过阈值 $LIMIT！禁止合并！"
            exit 1
          else
            echo "✅ 屎山指数 $SCORE 在可接受范围内（阈值：$LIMIT）"
          fi