name: ğŸ ä»£ç æ ¼å¼ä¸è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, master, dev/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  ruff-check:
    name: Ruff ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£… uv
        run: pip install uv

      - name: æ‰§è¡Œ Ruff æ ¼å¼åŒ–ä¸ä¿®å¤
        id: ruff
        # ä½¿ç”¨ || true ç¡®ä¿å³ä½¿æœ‰é”™è¯¯ä¹Ÿä¸ç«‹å³ä¸­æ–­ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ç”ŸæˆæŠ¥å‘Š
        run: |
          echo "Running ruff format..."
          FORMAT_LOG=$(uvx ruff format . 2>&1 || true)
          echo "$FORMAT_LOG"
          
          echo "Running ruff check --fix..."
          CHECK_LOG=$(uvx ruff check --fix . 2>&1 || true)
          echo "$CHECK_LOG"
          
          # å°†æ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­è„šæœ¬è¯»å–
          echo "$FORMAT_LOG" > format.log
          echo "$CHECK_LOG" > check.log

      - name: ç”ŸæˆæŠ¥å‘Šä¸è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const formatLog = fs.readFileSync('format.log', 'utf8');
            const checkLog = fs.readFileSync('check.log', 'utf8');
            
            // --- è§£ææ ¼å¼åŒ–æ—¥å¿— ---
            // ç¤ºä¾‹: "1 file reformatted, 2 files left unchanged."
            const formatMatch = formatLog.match(/(\d+) file(s)? reformatted/);
            const reformattedCount = formatMatch ? parseInt(formatMatch[1]) : 0;
            
            const unchangedMatch = formatLog.match(/(\d+) file(s)? left unchanged/);
            const unchangedCount = unchangedMatch ? parseInt(unchangedMatch[1]) : 0;
            
            // --- è§£ææ£€æŸ¥æ—¥å¿— ---
            // ç¤ºä¾‹: "Found 2 errors (1 fixed, 1 remaining)."
            let fixedCount = 0;
            let remainingCount = 0;
            let totalErrors = 0;
            
            const errorMatch = checkLog.match(/Found (\d+) error/);
            if (errorMatch) {
                totalErrors = parseInt(errorMatch[1]);
                
                const fixedMatch = checkLog.match(/\((\d+) fixed/);
                if (fixedMatch) fixedCount = parseInt(fixedMatch[1]);
                
                const remainingMatch = checkLog.match(/, (\d+) remaining\)/);
                if (remainingMatch) {
                    remainingCount = parseInt(remainingMatch[1]);
                } else {
                    // å¦‚æœæ²¡æœ‰è¯¦ç»†çš„ fixed/remaining ä¿¡æ¯ï¼Œé€šå¸¸æ„å‘³ç€æ²¡æœ‰ä¿®å¤æˆ–å…¨éƒ¨å‰©ä½™
                    if (fixedCount === 0) remainingCount = totalErrors;
                }
            }
            
            // --- æ„å»ºæŠ¥å‘Šå†…å®¹ ---
            let summary = '';
            let isSuccess = (reformattedCount === 0 && remainingCount === 0);
            
            if (isSuccess) {
                summary = '### âœ… All checked pass!';
            } else {
                summary = '### âš ï¸ ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š\n\n';
                summary += '> å‘ç°éƒ¨åˆ†æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–æˆ–å­˜åœ¨ä»£ç é—®é¢˜ï¼Œå»ºè®®åœ¨æœ¬åœ°è¿è¡Œ `ruff format .` å’Œ `ruff check --fix .`ã€‚\n\n';
                
                // æ ¼å¼åŒ–éƒ¨åˆ†
                if (reformattedCount > 0) {
                    summary += `**ğŸ–Œï¸ æ ¼å¼åŒ–**: \`${reformattedCount}\` ä¸ªæ–‡ä»¶è¢«é‡æ–°æ ¼å¼åŒ– (æœªå˜æ›´: ${unchangedCount})\n`;
                } else {
                    summary += `**ğŸ–Œï¸ æ ¼å¼åŒ–**: âœ… æ— éœ€å˜æ›´\n`;
                }
                
                // ä»£ç æ£€æŸ¥éƒ¨åˆ†
                if (totalErrors > 0) {
                    summary += `**ğŸ›¡ï¸ ä»£ç æ£€æŸ¥**: å‘ç° \`${totalErrors}\` ä¸ªé—®é¢˜\n`;
                    summary += `- ğŸ› ï¸ å·²è‡ªåŠ¨ä¿®å¤: \`${fixedCount}\`\n`;
                    summary += `- âŒ å‰©ä½™æœªä¿®å¤: \`${remainingCount}\`\n`;
                } else {
                    summary += `**ğŸ›¡ï¸ ä»£ç æ£€æŸ¥**: âœ… é€šè¿‡\n`;
                }
                
                // é”™è¯¯è¯¦æƒ… (å¦‚æœæœ‰å‰©ä½™é”™è¯¯)
                if (remainingCount > 0) {
                    // æˆªå–éƒ¨åˆ†æ—¥å¿—ä»¥é˜²è¿‡é•¿
                    const logPreview = checkLog.length > 2000 ? checkLog.substring(0, 2000) + '\n... (æ—¥å¿—è¿‡é•¿å·²æˆªæ–­)' : checkLog;
                    summary += `\n<details><summary>ğŸ” é”™è¯¯è¯¦æƒ…</summary>\n\n\`\`\`text${logPreview}\n\n\`\`\`\n</details>`;
                }
            }
            
            // --- è¾“å‡ºåˆ° Job Summary ---
            await core.summary.addRaw(summary).write();
            
            // --- PR è¯„è®º (ä»…åœ¨ PR äº‹ä»¶è§¦å‘æ—¶) ---
            if (context.eventName === 'pull_request') {
                const issue_number = context.issue.number;
                const owner = context.repo.owner;
                const repo = context.repo.repo;
                
                // è·å–ç°æœ‰è¯„è®º
                const comments = await github.rest.issues.listComments({
                    owner,
                    repo,
                    issue_number,
                });
                
                // æŸ¥æ‰¾æœºå™¨äººä¹‹å‰å‘çš„ Ruff æŠ¥å‘Šè¯„è®º
                const botComment = comments.data.find(comment =>
                    comment.user.type === 'Bot' &&
                    (comment.body.includes('ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š') || comment.body.includes('All checked pass'))
                );
                
                if (botComment) {
                    // å¦‚æœå·²æœ‰è¯„è®ºï¼Œæ›´æ–°å®ƒ
                    await github.rest.issues.updateComment({
                        owner,
                        repo,
                        comment_id: botComment.id,
                        body: summary
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰ï¼Œä¸”æ£€æŸ¥æœªé€šè¿‡ï¼Œåˆ™åˆ›å»ºæ–°è¯„è®º
                    // (å¦‚æœé€šè¿‡äº†ä¸”ä¹‹å‰æ²¡è¯„è®ºï¼Œå°±ä¸å‘äº†ï¼Œä¿æŒæ¸…çˆ½ï¼›é™¤éä½ æƒ³è®©ç”¨æˆ·çŸ¥é“é€šè¿‡äº†)
                    // è¿™é‡Œé€»è¾‘ï¼šå¦‚æœæœ‰é—®é¢˜ -> å‘/æ›´ï¼›å¦‚æœæ²¡é—®é¢˜ -> åªæœ‰åœ¨ä¹‹å‰æœ‰è¿‡æŠ¥é”™è¯„è®ºæ—¶æ‰æ›´æ–°ä¸ºé€šè¿‡ï¼Œå¦åˆ™ä¸æ‰“æ‰°ã€‚
                    if (!isSuccess) {
                        await github.rest.issues.createComment({
                            owner,
                            repo,
                            issue_number,
                            body: summary
                        });
                    }
                }
            }
            
            // --- è®¾ç½® Job çŠ¶æ€ ---
            if (!isSuccess) {
                core.setFailed('ä»£ç æ ¼å¼æˆ–è´¨é‡æ£€æµ‹æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Šã€‚');
            }
