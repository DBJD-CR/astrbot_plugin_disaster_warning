<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®³é¢„è­¦æ’ä»¶é…ç½®</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --light-bg: #f5f5f5;
            --dark-text: #333;
            --light-text: #666;
            --border-color: #ddd;
            --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--light-text);
            font-size: 1.1em;
        }

        .status-bar {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .config-section {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-hint {
            display: block;
            font-size: 0.85em;
            color: var(--light-text);
            margin-top: 4px;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .data-source-section {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .data-source-header {
            background-color: #f0f0f0;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .data-source-content {
            padding: 15px;
            display: none;
        }

        .data-source-content.show {
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #1976d2;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #f57c00;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .collapsible-content {
            display: none;
        }

        .collapsible-content.show {
            display: block;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸš¨ ç¾å®³é¢„è­¦æ’ä»¶é…ç½®</h1>
            <p class="subtitle">é€šè¿‡æ­¤é¡µé¢ç®¡ç†æ’ä»¶çš„æ‰€æœ‰é…ç½®é€‰é¡¹</p>
        </header>

        <!-- çŠ¶æ€ç›‘æ§é¢æ¿ -->
        <div class="config-section" id="status-panel" style="display: none;">
            <div class="section-header">å®æ—¶çŠ¶æ€ç›‘æ§</div>
            <div class="section-content" id="status-content">
                <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1; min-width: 200px; background: #e8f5e9; padding: 15px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">æœåŠ¡çŠ¶æ€</h4>
                        <div id="service-status-info">-</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: #e3f2fd; padding: 15px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; color: #1565c0;">æ´»è·ƒè¿æ¥</h4>
                        <div id="active-connections-info">-</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: #fff3e0; padding: 15px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; color: #ef6c00;">è¿è¡Œæ—¶é—´</h4>
                        <div id="uptime-info">-</div>
                    </div>
                </div>
                <div id="connection-details" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="status-bar" class="status-bar"></div>

        <form id="config-form">
            <!-- åŸºç¡€é…ç½® -->
            <div class="config-section">
                <div class="section-header">åŸºç¡€é…ç½®</div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¯ç”¨æ’ä»¶</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enabled" name="enabled">
                                <span class="slider"></span>
                            </label>
                            <span class="form-hint">å¯ç”¨æˆ–ç¦ç”¨æ•´ä¸ªç¾å®³é¢„è­¦æ’ä»¶</span>
                        </div>

                        <div class="form-group">
                            <label for="platform_name">æ¶ˆæ¯å¹³å°åç§°</label>
                            <input type="text" id="platform_name" name="platform_name" placeholder="å¦‚: aiocqhttp, defaultç­‰">
                            <span class="form-hint">åœ¨AstrBotä¸­é…ç½®çš„æœºå™¨äººå¹³å°åç§°</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="target_groups">ç›®æ ‡ç¾¤å·</label>
                        <textarea id="target_groups" name="target_groups" rows="2" placeholder="è¾“å…¥ç¾¤å·ï¼Œç”¨é€—å·åˆ†éš”ï¼šå¦‚ 123456789,987654321"></textarea>
                        <span class="form-hint">ç•™ç©ºåˆ™ä¸æ¨é€æ¶ˆæ¯åˆ°ç¾¤èŠ</span>
                    </div>

                    <div class="form-group">
                        <label for="target_users">ç›®æ ‡ç”¨æˆ·ï¼ˆç§èŠï¼‰</label>
                        <textarea id="target_users" name="target_users" rows="2" placeholder="è¾“å…¥ç”¨æˆ·IDï¼Œç”¨é€—å·åˆ†éš”ï¼šå¦‚ 111111,222222"></textarea>
                        <span class="form-hint">ç•™ç©ºåˆ™ä¸æ¨é€ç§èŠæ¶ˆæ¯</span>
                    </div>
                </div>
            </div>

            <!-- HTTPæœåŠ¡å™¨é…ç½® -->
            <div class="config-section">
                <div class="section-header">HTTPæœåŠ¡å™¨é…ç½®</div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¯ç”¨HTTPé…ç½®æœåŠ¡å™¨</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="http_enabled" name="http_config.enabled">
                                <span class="slider"></span>
                            </label>
                            <span class="form-hint">å¯ç”¨åå¯é€šè¿‡ç½‘é¡µé…ç½®æ’ä»¶</span>
                        </div>

                        <div class="form-group">
                            <label for="http_host">æœåŠ¡å™¨åœ°å€</label>
                            <input type="text" id="http_host" name="http_config.host" value="127.0.0.1">
                            <span class="form-hint">æœåŠ¡å™¨ç›‘å¬åœ°å€</span>
                        </div>

                        <div class="form-group">
                            <label for="http_port">æœåŠ¡å™¨ç«¯å£</label>
                            <input type="number" id="http_port" name="http_config.port" min="1" max="65535" value="8080">
                            <span class="form-hint">æœåŠ¡å™¨ç›‘å¬ç«¯å£ï¼ˆ1-65535ï¼‰</span>
                        </div>

                        <div class="form-group">
                            <label for="auth_token">è®¤è¯ä»¤ç‰Œ</label>
                            <input type="password" id="auth_token" name="http_config.auth_token" placeholder="å¯é€‰ï¼Œç”¨äºAPIè®¤è¯çš„ä»¤ç‰Œ">
                            <span class="form-hint">è®¾ç½®è®¿é—®ä»¤ç‰Œä»¥æé«˜å®‰å…¨æ€§</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç²¾ç»†åŒ–æ¨é€é…ç½® -->
            <div class="config-section">
                <div class="section-header">ç²¾ç»†åŒ–æ¨é€é…ç½®</div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¯ç”¨ç²¾ç»†åŒ–æ¨é€é…ç½®</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="advanced_enabled" name="advanced_target_config.enabled">
                                <span class="slider"></span>
                            </label>
                            <span class="form-hint">å¯ç”¨åå¯ä»¥ä¸ºæ¯ä¸ªæ•°æ®æºå•ç‹¬é…ç½®æ¨é€ç›®æ ‡</span>
                        </div>
                    </div>

                    <div id="advanced-config-container" style="display: none;">
                        <div class="form-group">
                            <div class="collapsible-header" onclick="toggleDataSourceSection()">
                                <h3 style="margin: 0;">æ•°æ®æºæ¨é€é…ç½®</h3>
                                <span id="data-source-expand-icon" class="expand-icon">â–¼</span>
                            </div>
                            <div id="data-source-content" class="collapsible-content">
                                <p class="form-hint" style="margin: 10px 0;">ä¸ºæ¯ä¸ªæ•°æ®æºå•ç‹¬é…ç½®æ¨é€ç›®æ ‡</p>
                                <!-- æ•°æ®æºé…ç½®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                                <div id="data-sources-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœ¬åœ°ç›‘æ§é…ç½® -->
            <div class="config-section">
                <div class="section-header">æœ¬åœ°çƒˆåº¦ç›‘æ§é…ç½®</div>
                <div class="section-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¯ç”¨æœ¬åœ°ç›‘æ§</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="local_enabled" name="local_monitoring.enabled">
                                <span class="slider"></span>
                            </label>
                            <span class="form-hint">å¯ç”¨åå¯è®¡ç®—æœ¬åœ°é¢„ä¼°çƒˆåº¦</span>
                        </div>

                        <div class="form-group">
                            <label for="local_latitude">æœ¬åœ°çº¬åº¦</label>
                            <input type="number" id="local_latitude" name="local_monitoring.latitude" step="any" placeholder="å¦‚: 39.9042">
                        </div>

                        <div class="form-group">
                            <label for="local_longitude">æœ¬åœ°ç»åº¦</label>
                            <input type="number" id="local_longitude" name="local_monitoring.longitude" step="any" placeholder="å¦‚: 116.4074">
                        </div>

                        <div class="form-group">
                            <label for="local_place_name">æœ¬åœ°åœ°å</label>
                            <input type="text" id="local_place_name" name="local_monitoring.place_name" placeholder="å¦‚: åŒ—äº¬å¸‚æµ·æ·€åŒº">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¯ç”¨ä¸¥æ ¼è¿‡æ»¤æ¨¡å¼</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="local_strict_mode" name="local_monitoring.strict_mode">
                                <span class="slider"></span>
                            </label>
                            <span class="form-hint">å¼€å¯åï¼Œå¦‚æœæœ¬åœ°çƒˆåº¦æœªè¾¾æ ‡ï¼Œå°†å¿½ç•¥æ‰€æœ‰é€šçŸ¥</span>
                        </div>

                        <div class="form-group">
                            <label for="local_intensity_threshold">é€šçŸ¥é˜ˆå€¼(çƒˆåº¦)</label>
                            <input type="number" id="local_intensity_threshold" name="local_monitoring.intensity_threshold" step="0.1" min="0" max="12" value="4.0" placeholder="å¦‚: 4.0">
                            <span class="form-hint">åªæœ‰å½“æœ¬åœ°é¢„ä¼°çƒˆåº¦å¤§äºç­‰äºæ­¤å€¼æ—¶æ‰é€šçŸ¥</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button type="button" id="load-btn" class="btn-secondary">ğŸ”„ åŠ è½½é…ç½®</button>
                <button type="button" id="reset-btn" class="btn-warning">â†º é‡ç½®è¡¨å•</button>
                <button type="button" id="status-btn" class="btn-primary">ğŸ“Š æŸ¥çœ‹çŠ¶æ€</button>
                <button type="button" id="refresh-status-btn" class="btn-secondary">ğŸ”„ åˆ·æ–°æœåŠ¡çŠ¶æ€</button>
            </div>
        </form>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            document.getElementById('load-btn').addEventListener('click', loadConfig);
            document.getElementById('config-form').addEventListener('submit', saveConfig);
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            document.getElementById('status-btn').addEventListener('click', checkStatus);
            document.getElementById('advanced_enabled').addEventListener('change', toggleAdvancedConfig);
            // æ·»åŠ åˆ·æ–°æœåŠ¡çŠ¶æ€æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('refresh-status-btn').addEventListener('click', refreshServiceStatus);
        });

        function toggleAdvancedConfig() {
            const container = document.getElementById('advanced-config-container');
            const isChecked = document.getElementById('advanced_enabled').checked;
            container.style.display = isChecked ? 'block' : 'none';
        }

        function toggleDataSourceSection() {
            const content = document.getElementById('data-source-content');
            const icon = document.getElementById('data-source-expand-icon');
            content.classList.toggle('show');
            icon.classList.toggle('rotated');
        }

        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status-bar');
            statusEl.textContent = message;
            statusEl.className = 'status-bar ' + (isError ? 'status-error' : 'status-success');
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function loadConfig() {
            try {
                showStatus('æ­£åœ¨åŠ è½½é…ç½®...');
                const response = await fetch('/config');
                if (response.ok) {
                    const config = await response.json();
                    populateForm(config);
                    toggleAdvancedConfig(); // æ ¹æ®åŠ è½½çš„é…ç½®çŠ¶æ€æ˜¾ç¤º/éšè—é«˜çº§é…ç½®
                    showStatus('âœ… é…ç½®åŠ è½½æˆåŠŸï¼');
                } else {
                    showStatus(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${response.statusText}`, true);
                }
            } catch (error) {
                showStatus(`âŒ åŠ è½½é…ç½®å‡ºé”™: ${error.message}`, true);
            }
        }

        async function saveConfig(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('config-form'));
            const config = formToConfig(formData);

            try {
                showStatus('æ­£åœ¨ä¿å­˜é…ç½®...');
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showStatus('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    const error = await response.text();
                    showStatus(`âŒ ä¿å­˜é…ç½®å¤±è´¥: ${error}`, true);
                }
            } catch (error) {
                showStatus(`âŒ ä¿å­˜é…ç½®å‡ºé”™: ${error.message}`, true);
            }
        }

        function resetForm() {
            if (confirm('ç¡®å®šè¦é‡ç½®è¡¨å•å—ï¼Ÿè¿™å°†æ¸…ç©ºå½“å‰æ‰€æœ‰è¾“å…¥ã€‚')) {
                document.getElementById('config-form').reset();
            }
        }

        async function checkStatus() {
            try {
                // è·å–HTTPæœåŠ¡å™¨çŠ¶æ€
                const response = await fetch('/api/status');
                if (response.ok) {
                    const status = await response.json();
                    showStatus(`ğŸ“Š HTTPæœåŠ¡å™¨çŠ¶æ€: è¿è¡Œä¸­ï¼Œåœ°å€ ${status.host}:${status.port}`);
                    
                    // è·å–æ’ä»¶æœåŠ¡çŠ¶æ€å¹¶æ˜¾ç¤º
                    if (status.plugin_service_status) {
                        updateStatusPanel(status.plugin_service_status);
                        document.getElementById('status-panel').style.display = 'block';
                    }
                } else {
                    showStatus(`âŒ è·å–çŠ¶æ€å¤±è´¥: ${response.statusText}`, true);
                }
            } catch (error) {
                showStatus(`âŒ è·å–çŠ¶æ€å‡ºé”™: ${error.message}`, true);
            }
        }

        async function updateStatusPanel(serviceStatus) {
            try {
                // æ›´æ–°æœåŠ¡çŠ¶æ€ä¿¡æ¯
                const serviceStatusInfo = document.getElementById('service-status-info');
                if (serviceStatusInfo) {
                    const runningText = serviceStatus.running ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'ğŸ”´ å·²åœæ­¢';
                    serviceStatusInfo.innerHTML = `
                        <strong>è¿è¡ŒçŠ¶æ€:</strong> ${runningText}<br>
                        <strong>æ´»è·ƒWebSocketè¿æ¥:</strong> ${serviceStatus.active_websocket_connections || 0} / ${serviceStatus.total_connections || 0}<br>
                        <strong>Global Quakeè¿æ¥:</strong> ${serviceStatus.global_quake_connected ? 'ğŸŸ¢ å·²è¿æ¥' : 'ğŸ”´ æœªè¿æ¥'}
                    `;
                }

                // æ›´æ–°æ´»è·ƒè¿æ¥ä¿¡æ¯
                const activeConnectionsInfo = document.getElementById('active-connections-info');
                if (activeConnectionsInfo && serviceStatus.connection_details) {
                    const activeCount = Object.values(serviceStatus.connection_details).filter(conn => conn.connected).length;
                    activeConnectionsInfo.innerHTML = `
                        <strong>æ´»è·ƒè¿æ¥æ•°:</strong> ${activeCount}<br>
                        <strong>æ€»è¿æ¥æ•°:</strong> ${Object.keys(serviceStatus.connection_details).length}
                    `;
                }

                // æ›´æ–°è¿è¡Œæ—¶é—´ä¿¡æ¯
                const uptimeInfo = document.getElementById('uptime-info');
                if (uptimeInfo) {
                    uptimeInfo.textContent = serviceStatus.uptime || 'æœªçŸ¥';
                }

                // æ›´æ–°è¿æ¥è¯¦æƒ…
                const connectionDetails = document.getElementById('connection-details');
                if (connectionDetails && serviceStatus.connection_details) {
                    let detailsHtml = '<h4>è¿æ¥è¯¦æƒ…</h4><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">';
                    for (const [name, detail] of Object.entries(serviceStatus.connection_details)) {
                        const statusIcon = detail.connected ? 'ğŸŸ¢' : 'ğŸ”´';
                        const retryText = detail.retry_count > 0 ? ` (é‡è¯•: ${detail.retry_count})` : '';
                        const uri = detail.uri ? detail.uri.substring(0, 30) + (detail.uri.length > 30 ? '...' : '') : 'æœªçŸ¥';
                        detailsHtml += `
                            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #fafafa;">
                                <strong>${statusIcon} ${name}</strong><br>
                                <small>åœ°å€: ${uri}</small><br>
                                <small>çŠ¶æ€: ${detail.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}${retryText}</small>
                            </div>
                        `;
                    }
                    detailsHtml += '</div>';
                    connectionDetails.innerHTML = detailsHtml;
                }
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€é¢æ¿å¤±è´¥:', error);
            }
        }

        // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆå¯é€‰ï¼Œé€šè¿‡æŒ‰é’®è§¦å‘ï¼‰
        async function refreshServiceStatus() {
            try {
                const response = await fetch('/api/service_status');
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        updateStatusPanel(result.data);
                        document.getElementById('status-panel').style.display = 'block';
                        showStatus('âœ… æœåŠ¡çŠ¶æ€å·²åˆ·æ–°');
                    } else {
                        showStatus(`âŒ è·å–æœåŠ¡çŠ¶æ€å¤±è´¥: ${result.message}`, true);
                    }
                } else {
                    showStatus(`âŒ è·å–æœåŠ¡çŠ¶æ€å¤±è´¥: ${response.statusText}`, true);
                }
            } catch (error) {
                showStatus(`âŒ è·å–æœåŠ¡çŠ¶æ€å‡ºé”™: ${error.message}`, true);
            }
        }

        function populateForm(config) {
            try {
                // åŸºç¡€é…ç½®
                setCheckboxValue('enabled', config.enabled);
                setValue('platform_name', config.platform_name || 'aiocqhttp');
                setArrayValue('target_groups', config.target_groups || []);
                setArrayValue('target_users', config.target_users || []);

                // HTTPæœåŠ¡å™¨é…ç½®
                setCheckboxValue('http_enabled', config.http_config?.enabled);
                setValue('http_host', config.http_config?.host || '127.0.0.1');
                setValue('http_port', config.http_config?.port || 8080);
                setValue('auth_token', config.http_config?.auth_token || '');

                // ç²¾ç»†åŒ–æ¨é€é…ç½®
                setCheckboxValue('advanced_enabled', config.advanced_target_config?.enabled);
                // å¢å¼ºé”™è¯¯å¤„ç†ï¼šç¡®ä¿data_source_targetså­˜åœ¨
                const dataSourceTargets = config.advanced_target_config?.data_source_targets || {};
                updateDataSourceConfig(dataSourceTargets);

                // æœ¬åœ°ç›‘æ§é…ç½®
                setCheckboxValue('local_enabled', config.local_monitoring?.enabled);
                setValue('local_latitude', config.local_monitoring?.latitude);
                setValue('local_longitude', config.local_monitoring?.longitude);
                setValue('local_place_name', config.local_monitoring?.place_name || 'æœ¬åœ°');
                setCheckboxValue('local_strict_mode', config.local_monitoring?.strict_mode);
                setValue('local_intensity_threshold', config.local_monitoring?.intensity_threshold || 4.0);
            } catch (error) {
                console.error('å¡«å……é…ç½®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showStatus(`âŒ å¡«å……é…ç½®å¤±è´¥: ${error.message}`, true);
            }
        }

        async function updateDataSourceConfig(dataSourceTargets = {}) {
            try {
                const container = document.getElementById('data-sources-container');
                if (!container) {
                    console.error('æ‰¾ä¸åˆ°æ•°æ®æºå®¹å™¨å…ƒç´ ');
                    return;
                }
                // æ¸…ç©ºç°æœ‰å†…å®¹
                container.innerHTML = '';
                
                // ä»åç«¯è·å–æ•°æ®æºé…ç½®
                let dataSources = [];
                try {
                    const response = await fetch('/api/data_sources');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            dataSources = Object.entries(result.data_sources).map(([id, config]) => ({
                                id: id,
                                name: config.display_name,
                                description: config.description
                            }));
                        }
                    } else {
                        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨
                        dataSources = [
                            {id: 'cea_fanstudio', name: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘', description: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘'},
                            {id: 'cea_wolfx', name: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘ï¼ˆWolfxï¼‰', description: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘ï¼ˆWolfxï¼‰'},
                            {id: 'cwa_fanstudio', name: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²', description: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²'},
                            {id: 'cwa_wolfx', name: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²ï¼ˆWolfxï¼‰', description: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²ï¼ˆWolfxï¼‰'},
                            {id: 'jma_fanstudio', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥'},
                            {id: 'jma_p2p', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆP2Pï¼‰'},
                            {id: 'jma_wolfx', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆWolfxï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆWolfxï¼‰'},
                            {id: 'global_quake', name: 'Global Quake', description: 'Global Quake'},
                            {id: 'cenc_fanstudio', name: 'ä¸­å›½åœ°éœ‡å°ç½‘', description: 'ä¸­å›½åœ°éœ‡å°ç½‘'},
                            {id: 'cenc_wolfx', name: 'ä¸­å›½åœ°éœ‡å°ç½‘ï¼ˆWolfxï¼‰', description: 'ä¸­å›½åœ°éœ‡å°ç½‘ï¼ˆWolfxï¼‰'},
                            {id: 'jma_p2p_info', name: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆP2Pï¼‰'},
                            {id: 'jma_wolfx_info', name: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆWolfxï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆWolfxï¼‰'},
                            {id: 'usgs_fanstudio', name: 'ç¾å›½åœ°è´¨è°ƒæŸ¥å±€', description: 'ç¾å›½åœ°è´¨è°ƒæŸ¥å±€'},
                            {id: 'china_tsunami_fanstudio', name: 'ä¸­å›½æµ·å•¸é¢„è­¦ä¸­å¿ƒ', description: 'ä¸­å›½æµ·å•¸é¢„è­¦ä¸­å¿ƒ'},
                            {id: 'jma_tsunami_p2p', name: 'æ—¥æœ¬æ°”è±¡å…æµ·å•¸é¢„æŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…æµ·å•¸é¢„æŠ¥ï¼ˆP2Pï¼‰'},
                            {id: 'china_weather_fanstudio', name: 'ä¸­å›½æ°”è±¡å±€', description: 'ä¸­å›½æ°”è±¡å±€'}
                        ];
                    }
                } catch (error) {
                    console.error('è·å–æ•°æ®æºåˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨:', error);
                    // ä½¿ç”¨é»˜è®¤æ•°æ®æºåˆ—è¡¨
                    dataSources = [
                        {id: 'cea_fanstudio', name: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘', description: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘'},
                        {id: 'cea_wolfx', name: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘ï¼ˆWolfxï¼‰', description: 'ä¸­å›½åœ°éœ‡é¢„è­¦ç½‘ï¼ˆWolfxï¼‰'},
                        {id: 'cwa_fanstudio', name: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²', description: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²'},
                        {id: 'cwa_wolfx', name: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²ï¼ˆWolfxï¼‰', description: 'å°æ¹¾ä¸­å¤®æ°”è±¡ç½²ï¼ˆWolfxï¼‰'},
                        {id: 'jma_fanstudio', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥'},
                        {id: 'jma_p2p', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆP2Pï¼‰'},
                        {id: 'jma_wolfx', name: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆWolfxï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…ç´§æ€¥åœ°éœ‡é€ŸæŠ¥ï¼ˆWolfxï¼‰'},
                        {id: 'global_quake', name: 'Global Quake', description: 'Global Quake'},
                        {id: 'cenc_fanstudio', name: 'ä¸­å›½åœ°éœ‡å°ç½‘', description: 'ä¸­å›½åœ°éœ‡å°ç½‘'},
                        {id: 'cenc_wolfx', name: 'ä¸­å›½åœ°éœ‡å°ç½‘ï¼ˆWolfxï¼‰', description: 'ä¸­å›½åœ°éœ‡å°ç½‘ï¼ˆWolfxï¼‰'},
                        {id: 'jma_p2p_info', name: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆP2Pï¼‰'},
                        {id: 'jma_wolfx_info', name: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆWolfxï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…åœ°éœ‡æƒ…æŠ¥ï¼ˆWolfxï¼‰'},
                        {id: 'usgs_fanstudio', name: 'ç¾å›½åœ°è´¨è°ƒæŸ¥å±€', description: 'ç¾å›½åœ°è´¨è°ƒæŸ¥å±€'},
                        {id: 'china_tsunami_fanstudio', name: 'ä¸­å›½æµ·å•¸é¢„è­¦ä¸­å¿ƒ', description: 'ä¸­å›½æµ·å•¸é¢„è­¦ä¸­å¿ƒ'},
                        {id: 'jma_tsunami_p2p', name: 'æ—¥æœ¬æ°”è±¡å…æµ·å•¸é¢„æŠ¥ï¼ˆP2Pï¼‰', description: 'æ—¥æœ¬æ°”è±¡å…æµ·å•¸é¢„æŠ¥ï¼ˆP2Pï¼‰'},
                        {id: 'china_weather_fanstudio', name: 'ä¸­å›½æ°”è±¡å±€', description: 'ä¸­å›½æ°”è±¡å±€'}
                    ];
                }

                dataSources.forEach(ds => {
                    try {
                        // åˆ›å»ºæ•°æ®æºé…ç½®å®¹å™¨
                        const dsDiv = document.createElement('div');
                        dsDiv.className = 'data-source-section';
                        
                        // å®‰å…¨è·å–é…ç½®å€¼ï¼Œé˜²æ­¢é”™è¯¯
                        const dsConfig = dataSourceTargets[ds.id] || {};
                        const enabled = dsConfig.enabled === true || dsConfig.enabled === 'true';
                        const targetGroups = Array.isArray(dsConfig.target_groups) ? dsConfig.target_groups.join(',') : (typeof dsConfig.target_groups === 'string' ? dsConfig.target_groups : '');
                        const targetUsers = Array.isArray(dsConfig.target_users) ? dsConfig.target_users.join(',') : (typeof dsConfig.target_users === 'string' ? dsConfig.target_users : '');
                        
                        dsDiv.innerHTML = `
                            <div class="data-source-header" onclick="toggleDataSource('${ds.id}')">
                                <span>${ds.name} <small>(${ds.id})</small></span>
                                <span class="expand-icon">â–¼</span>
                            </div>
                            <div id="ds-${ds.id}-content" class="data-source-content">
                                <div class="form-grid" style="grid-template-columns: 1fr;">
                                    <div class="form-group">
                                        <label>å¯ç”¨æ¨é€</label>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="advanced_${ds.id}_enabled" name="advanced_target_config.data_source_targets.${ds.id}.enabled" ${enabled ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="advanced_${ds.id}_groups">æ¨é€ç¾¤å·</label>
                                    <textarea id="advanced_${ds.id}_groups" name="advanced_target_config.data_source_targets.${ds.id}.target_groups" rows="2" placeholder="è¾“å…¥ç¾¤å·ï¼Œç”¨é€—å·åˆ†éš”ï¼šå¦‚ 123456789,987654321">${targetGroups}</textarea>
                                    <span class="form-hint">è¾“å…¥éœ€è¦æ¥æ”¶æ­¤æ•°æ®æºæ¶ˆæ¯çš„ç¾¤å·ï¼Œç”¨é€—å·åˆ†éš”</span>
                                </div>
                                <div class="form-group">
                                    <label for="advanced_${ds.id}_users">æ¨é€ç”¨æˆ·ï¼ˆç§èŠï¼‰</label>
                                    <textarea id="advanced_${ds.id}_users" name="advanced_target_config.data_source_targets.${ds.id}.target_users" rows="2" placeholder="è¾“å…¥ç”¨æˆ·IDï¼Œç”¨é€—å·åˆ†éš”ï¼šå¦‚ 111111,222222">${targetUsers}</textarea>
                                    <span class="form-hint">è¾“å…¥éœ€è¦æ¥æ”¶æ­¤æ•°æ®æºæ¶ˆæ¯çš„ç”¨æˆ·IDï¼Œç”¨é€—å·åˆ†éš”</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(dsDiv);
                    } catch (error) {
                        console.error(`ç”Ÿæˆæ•°æ®æº ${ds.id} é…ç½®æ—¶å‡ºé”™:`, error);
                        // åˆ›å»ºä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„é…ç½®é¡¹
                        const dsDiv = document.createElement('div');
                        dsDiv.className = 'data-source-section';
                        dsDiv.innerHTML = `
                            <div class="data-source-header" onclick="toggleDataSource('${ds.id}')">
                                <span>${ds.name} <small>(${ds.id})</small></span>
                                <span class="expand-icon">â–¼</span>
                            </div>
                            <div id="ds-${ds.id}-content" class="data-source-content">
                                <p style="color: #f44336; padding: 10px;">é…ç½®é¡¹åŠ è½½å¤±è´¥: ${error.message}</p>
                            </div>
                        `;
                        container.appendChild(dsDiv);
                    }
                });
            } catch (error) {
                console.error('æ›´æ–°æ•°æ®æºé…ç½®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showStatus(`âŒ æ›´æ–°æ•°æ®æºé…ç½®å¤±è´¥: ${error.message}`, true);
            }
        }

        function toggleDataSource(id) {
            try {
                const content = document.getElementById(`ds-${id}-content`);
                if (!content) return;
                const icon = content.previousElementSibling.querySelector('.expand-icon');
                if (!icon) return;
                content.classList.toggle('show');
                icon.classList.toggle('rotated');
            } catch (error) {
                console.error(`åˆ‡æ¢æ•°æ®æº ${id} æ—¶å‡ºé”™:`, error);
            }
        }

        function setCheckboxValue(id, value) {
            try {
                const element = document.getElementById(id);
                if (element) {
                    element.checked = value === true || value === 'true';
                }
            } catch (error) {
                console.error(`è®¾ç½®å¤é€‰æ¡† ${id} å€¼æ—¶å‡ºé”™:`, error);
            }
        }

        function setValue(id, value) {
            try {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value !== undefined ? value : '';
                }
            } catch (error) {
                console.error(`è®¾ç½®è¾“å…¥æ¡† ${id} å€¼æ—¶å‡ºé”™:`, error);
            }
        }

        function setArrayValue(id, value) {
            try {
                const element = document.getElementById(id);
                if (element) {
                    element.value = Array.isArray(value) ? value.join(',') : '';
                }
            } catch (error) {
                console.error(`è®¾ç½®æ•°ç»„å€¼ ${id} æ—¶å‡ºé”™:`, error);
            }
        }

        function formToConfig(formData) {
            const config = {};
            for (let [key, value] = formData.entries()) {
                setNestedProperty(config, key, value);
            }

            // å¤„ç†å¤é€‰æ¡†çš„å€¼ï¼ˆå¦‚æœæ²¡æœ‰é€‰ä¸­åˆ™ä¸ä¼šåœ¨formDataä¸­å‡ºç°ï¼Œéœ€è¦ç‰¹åˆ«å¤„ç†ï¼‰
            const checkboxes = ['enabled', 'http_config.enabled', 'advanced_target_config.enabled', 'local_monitoring.enabled', 'local_monitoring.strict_mode'];
            for (const checkboxKey of checkboxes) {
                if (document.querySelector(`input[type="checkbox"][name="${checkboxKey}"]`) && config[checkboxKey] === undefined) {
                    setNestedProperty(config, checkboxKey, false);
                }
            }

            return config;
        }

        function setNestedProperty(obj, path, value) {
            const keys = path.split('.');
            let current = obj;

            for (let i = 0; i < keys.length - 1; i++) {
                if (!(keys[i] in current)) {
                    current[keys[i]] = {};
                }
                current = current[keys[i]];
            }

            // ç‰¹æ®Šå¤„ç†æ•°ç»„ç±»å‹çš„å€¼
            if (keys[keys.length - 1].includes('target_') && value) {
                value = value.split(',').map(item => item.trim()).filter(item => item);
            }

            // ç‰¹æ®Šå¤„ç†å¸ƒå°”ç±»å‹çš„å€¼
            if (value === 'true') value = true;
            else if (value === 'false') value = false;
            else if (!isNaN(value) && !isNaN(parseFloat(value))) value = parseFloat(value);
            else if (value === '') value = undefined; // ç©ºå€¼å¤„ç†

            current[keys[keys.length - 1]] = value;
        }
    </script>
</body>

</html>